{% extends 'base.html.twig' %}

{% block title 'Facturation' %}

{% block meta %}
    <script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block body %}
<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
    <div class="d-flex flex-column flex-column-fluid">
        <div id="kt_app_toolbar" class="app-toolbar mt-lg-0 mt-lg-n5 pt-4 pt-lg-0 pb-4 pb-lg-8">
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack flex-wrap">
                <div class="app-toolbar-wrapper d-flex flex-stack flex-wrap gap-4 w-100">
                    <div class="page-title d-flex flex-column justify-content-center me-3">
                        <h1 class="page-heading d-flex title-custom fw-bolder fs-2hx flex-column justify-content-center my-0"> {{ block('title') }}</h1>
                        <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                            <li class="breadcrumb-item text-gray-700">
                                <a href="{{ path('home') }}" class="text-gray-700 text-hover-primary">Accueil</a>
                            </li>
                            <li class="breadcrumb-item">
                                <i class="ki-duotone ki-right fs-7 text-gray-700"></i>
                            </li>
                            <li class="breadcrumb-item text-gray-700">{{ block('title') }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <div id="kt_app_content_container" class="app-container container-xxl">
                <div class="card mb-5 mb-xl-10">
                    <div class="card-body pt-9 pb-0">
                        {% include 'account/_nav.html.twig' %}
                    </div>
                </div>
                <div class="card mb-5 mb-xl-10">
                    <div class="card card-flush pt-3 mb-5 mb-xl-10">
                        <div class="card-header">
                            <div class="card-title">
                                <h2 class="fw-bold">Abonnement</h2>
                            </div>
                            <div class="card-toolbar">
                                <a href="{{ path('account_billing_manager') }}" class="btn btn-light-primary">Mettre à jour</a>
                            </div>
                        </div>
                        <div class="card-body pt-3">
                            <div class="notice d-flex bg-light-warning rounded border-warning border border-dashed mb-12 p-6">
                                <i class="ki-duotone ki-information fs-2tx text-warning me-4">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <div class="d-flex flex-stack flex-grow-1">

                                    <div class="fw-semibold">
                                        <h4 class="text-gray-900 fw-bold">We need your attention!</h4>
                                        <div class="fs-6 text-gray-700">Your payment was declined. To start using tools, please
                                            <a href="#" class="fw-bold" data-bs-toggle="modal" data-bs-target="#kt_modal_new_card">Add Payment Method</a>.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-10">
                                <h5 class="mb-4">Billing Address:</h5>
                                <div class="d-flex flex-wrap py-5">
                                    <div class="flex-equal me-5">
                                        <table class="table fs-6 fw-semibold gs-0 gy-2 gx-2 m-0">
                                            <tr>
                                                <td class="text-gray-400 min-w-175px w-175px">Bill to:</td>
                                                <td class="text-gray-800 min-w-200px">
                                                    <a href="../../demo47/dist/pages/apps/customers/view.html" class="text-gray-800 text-hover-primary">smith@kpmg.com</a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Customer Name:</td>
                                                <td class="text-gray-800">Emma Smith</td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Address:</td>
                                                <td class="text-gray-800">Floor 10, 101 Avenue of the Light Square, New York, NY, 10050.</td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Phone:</td>
                                                <td class="text-gray-800">(555) 555-1234</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="flex-equal">
                                        <table class="table fs-6 fw-semibold gs-0 gy-2 gx-2 m-0">
                                            <tr>
                                                <td class="text-gray-400 min-w-175px w-175px">Subscribed Product:</td>
                                                <td class="text-gray-800 min-w-200px">
                                                    <a href="#" class="text-gray-800 text-hover-primary">Basic Bundle</a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Subscription Fees:</td>
                                                <td class="text-gray-800">$149.99 / Year</td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Billing method:</td>
                                                <td class="text-gray-800">Annually</td>
                                            </tr>
                                            <tr>
                                                <td class="text-gray-400">Currency:</td>
                                                <td class="text-gray-800">USD - US Dollar</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="kt_modal_upgrade_plan" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content rounded">
                <div class="modal-header justify-content-end border-0 pb-0">
                    <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                        <i class="ki-duotone ki-cross fs-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </div>
                </div>
                <div class="modal-body pt-0 pb-15 px-5 px-xl-20">
                    <div class="mb-13 text-center">
                        <h1 class="mb-3">Upgrade a Plan</h1>
                        <div class="text-muted fw-semibold fs-5">If you need more info, please check
                            <a href="#" class="link-primary fw-bold">Pricing Guidelines</a>.</div>
                    </div>
                    <div class="d-flex flex-column">
                        <div class="nav-group nav-group-outline mx-auto" data-kt-buttons="true">
                            <button class="btn btn-color-gray-400 btn-active btn-active-secondary px-6 py-3 me-2 active" data-kt-plan="month">Monthly</button>
                            <button class="btn btn-color-gray-400 btn-active btn-active-secondary px-6 py-3" data-kt-plan="annual">Annual</button>
                        </div>
                        <div class="row mt-10">
                            <div class="col-lg-6 mb-10 mb-lg-0">
                                <div class="nav flex-column">
                                    {% for plan in plans %}
                                        <label class="plan_selection nav-link btn btn-outline btn-outline-dashed btn-color-dark btn-active-primary d-flex flex-stack text-start p-6 mb-6" plan-id="{{ plan.id }}" data-bs-toggle="tab" data-bs-target="#kt_upgrade_plan_{{ plan.id }}">
                                            <div class="d-flex align-items-center me-2">
                                                <div class="form-check form-check-custom form-check-solid form-check-success flex-shrink-0 me-6">
                                                    <input class="form-check-input" type="radio" name="plan" value="{{ plan.id }}" />
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center fs-2 fw-bold flex-wrap">{{ plan.name }}
                                                        {% if plan.popular %}
                                                            <span class="badge badge-light-success ms-2 py-2 px-3 fs-7">Populaire</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="fw-semibold opacity-75">{{ plan.shortDescription }}</div>
                                                </div>
                                            </div>
                                            <div class="ms-5">
                                                <span class="fs-3x fw-bold" data-kt-plan-price-month="39" data-kt-plan-price-annual="399">{{ plan.price }}</span>
                                                <span class="mb-2">€</span>
                                                <span class="fs-7 opacity-50">/
                                                    <span data-kt-element="period">Mois</span></span>
                                            </div>
                                        </label>
                                    {% endfor %}
                                    <label class="nav-link btn btn-outline btn-outline-dashed btn-color-dark btn-active btn-active-primary d-flex flex-stack text-start p-6 mb-6" data-bs-toggle="tab" data-bs-target="#kt_upgrade_plan_custom">
                                        <div class="d-flex align-items-center me-2">
                                            <div class="form-check form-check-custom form-check-solid form-check-success flex-shrink-0 me-6">
                                                <input class="form-check-input" type="radio" name="plan" value="custom" />
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center fs-2 fw-bold flex-wrap">Custom</div>
                                                <div class="fw-semibold opacity-75">Requet a custom license</div>
                                            </div>
                                        </div>
                                        <div class="ms-5">
                                            <a href="#" class="btn btn-sm btn-success">Contact Us</a>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="tab-content rounded h-100 bg-light p-10">
                                    {% for plan in plans %}
                                        <div class="tab-pane fade show" id="kt_upgrade_plan_{{ plan.id }}">
                                            <div class="pb-5">
                                                <h2 class="fw-bold text-dark">Ce qui est inclus dans {{ plan.name }}</h2>
                                                <div class="text-muted fw-semibold">{{ plan.shortDescription }}</div>
                                            </div>
                                            <div class="pt-1">
                                                {% for atout in plan.longDescription %}
                                                    <div class="d-flex align-items-center mb-7">
                                                        <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">{{ atout.text }}</span>
                                                        {% if atout.check %}
                                                            <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                        {% else %}
                                                            <i class="ki-duotone ki-cross-circle fs-1">
                                                                <span class="path1"></span>
                                                                <span class="path2"></span>
                                                            </i>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <div class="tab-pane fade" id="kt_upgrade_plan_custom">
                                        <div class="pb-5">
                                            <h2 class="fw-bold text-dark">What’s in Startup Plan?</h2>
                                            <div class="text-muted fw-semibold">Optimal for corporations</div>
                                        </div>
                                        <div class="pt-1">
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Unlimited Users</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Unlimited Project Integrations</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Analytics Module</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Finance Module</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Accounting Module</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center mb-7">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Network Platform</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="fw-semibold fs-5 text-gray-700 flex-grow-1">Unlimited Cloud Space</span>
                                                <i class="ki-duotone ki-check-circle fs-1 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-center flex-row-fluid pt-12">
                        <button type="reset" class="btn btn-light me-3" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" class="btn btn-primary" id="checkout-btn">
                                <span class="indicator-label">Souscrire</span>
                            </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts_footer %}
    <script>
        var stripe = Stripe('{{ stripeKey() }}');
        var checkoutBtn = document.getElementById('checkout-btn');
        checkoutBtn.addEventListener('click', function() {
            var selectedPlan = document.querySelector('label.plan_selection[aria-selected="true"]');
            if (!selectedPlan) {
                alert('Veuillez sélectionner un plan avant de continuer.');
                return;
            }

            var planId = selectedPlan.getAttribute('plan-id');

            fetch('{{ path('billing_stripe', {'subscription': 1}) }}', {
                method: 'POST',
                body: JSON.stringify({ plan_id: planId }),
            })
                .then(function(response) {
                    return response.json();
                })
                .then(function(session) {
                    return stripe.redirectToCheckout({ sessionId: session.id });
                })
                .then(function(result) {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                });
        });
    </script>
{% endblock %}
